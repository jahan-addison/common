var Base64;

Base64 = {

	rank: [
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255, 62,255,255,255, 63,
		 52, 53, 54, 55, 56, 57, 58, 59, 60, 61,255,255,255,  0,255,255,
		255,  0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14,
		 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25,255,255,255,255,255,
		255, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
		 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,
		255,255,255,255,255,255,255,255,255,255,255,255,255,255,255,255
	],

	alphabet: "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",

	encode: function(binary) {
		throw new Error("Base64.encode is not implemented.");
	},

	decode: function(string) {
		var
			  len = string.length
			, buffer = new Uint8Array(len / 4 * 3 + 1 | 0);
			, i = 0
			, outptr = 0
			, last = [0, 0]
			, state = 0,
			, save = 0
			, rank
			, code;
		
		while (len--) {
			code = string.charCodeAt(i++);
			rank = Base64.rank[code];
			if (rank !== 0xFF && rank !== undefined) {
				last[1] = last[0];
				last[0] = code;
				save = (save << 6) | rank;
				state++;
				if (state === 4) {
					buffer[outptr++] = save >>> 16;
					if (last[1] !== 61 /* = character */) {
						buffer[outptr++] = save >>> 8;
					}
					if (last[0] !== 61 /* = character */) {
						buffer[outptr++] = save;
					}
					state = 0;
				}
			}
		}
		return buffer.subarray(0, outptr);
	}
};
